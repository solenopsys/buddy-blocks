# Архитектура блочного хранилища (single instance)

## Концепция

Высокопроизводительное блочное хранилище с контекстной адресацией на базе buddy алгоритма .

---

## Компоненты

### 1. Data File
- Единый большой файл
- Растет макроблоками по 1MB
- Содержит блоки фиксированных размеров: 4KB, 8KB, 16KB, 32KB, 64KB, 128KB, 256KB, 512KB
- **Данные иммутабельны после записи**

### 2. LMDBX (метаданные)
**Индекс блоков:**
 
```
 
 
Есть буферизации на уровне файла допустим 16 мегабайт. 


# хранение ссылок на пустые блоки 

4k_{n}-> {buddy:n}
8k_{n}-> {buddy:n}
16k_{n}-> {buddy:n}
32k_{n}-> {buddy:n}
64k_{n}-> {buddy:n}
128k_{n}-> {buddy:n}
256k_{n}-> {buddy:n}
512k_{n}-> {buddy:n} 

дальше уже макроблок которые выделяются по 1024

# хранение ссылок на данные
hash-> {block_size, block_num, buddy_num}

## Добавление
При записи в общей транзакци()
запрос блока()
если блока нет то 
динамический сплит до()

## Удаление
При удалении в общей тразакцуи
Высвобождение блока с проверкой соседа 
(если он свободен то слияние, после слияния каскадом вверх) рекурсия

## запись данных на диск идет потоком 
Запись всегда идет потоком и транзакция подтверждается только в конце()
то есть приходит http запрос анализируется его размер и берется хеш из урла. 
из размера берется ячейка или ошибка
дальше идет запись на диск данных в заданной ячейке
в конце проверка хеша.
если ошибка откат транзакции. 

## как будут записываться блоки или читаться
блоки будут записвываться напрямую используя запись по 4 килобайта через uring технолгию ни какой буферизации 